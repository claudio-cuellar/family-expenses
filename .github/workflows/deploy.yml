name: Deploy Django to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "ðŸš€ Starting deployment on EC2..."

            # Update system
            sudo apt-get update -y
            sudo apt-get upgrade -y

            # Install prerequisites
            sudo apt-get install -y python3 python3-pip python3-venv libpq-dev python3-dev

            # Create project directory if missing
            mkdir -p /home/ubuntu/api
            cd /home/ubuntu/api

            # Clone repo if not exists
            if [ ! -d ".git" ]; then
              git clone https://github.com/claudio-cuellar/family-expenses.git .
            fi

            # Reset to latest code
            git fetch --all
            git reset --hard origin/main

            # Setup venv if missing
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate

            # Upgrade pip + install deps
            pip install --upgrade pip
            pip install -r requirements.txt

            # Set DJANGO_SETTINGS_MODULE for production
            export DJANGO_SETTINGS_MODULE=family_expenses.settings.prod

            # Apply DB migrations
            python3 manage.py migrate --noinput

            # Collect static files
            python3 manage.py collectstatic --noinput

            # Setup/Update Gunicorn systemd service
            echo "Setting up Gunicorn..."
            sudo bash -c 'cat > /etc/systemd/system/gunicorn.service <<EOF
            [Unit]
            Description=gunicorn daemon
            After=network.target

            [Service]
            User=ubuntu
            Group=www-data
            WorkingDirectory=/home/ubuntu/family_expenses
            Environment="DATABASE_URL=${{ secrets.DATABASE_URL }}"
            ExecStart=/home/ubuntu/family_expenses/venv/bin/gunicorn \
                      --access-logfile - \
                      --workers 3 --bind unix:/home/ubuntu/api/gunicorn.sock family_expenses.wsgi:application

            [Install]
            WantedBy=multi-user.target" | sudo tee /etc/systemd/system/gunicorn.service

            # Reload systemd and restart services
            sudo systemctl daemon-reload
            sudo systemctl enable gunicorn
            sudo systemctl restart gunicorn
            sudo nginx -t
            sudo systemctl reload nginx

            echo "âœ… Deployment finished successfully!"
          EOF